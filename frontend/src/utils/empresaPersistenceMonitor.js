/**
 * üîç MONITOR PERSISTENCIA DATOS EMPRESA
 * 
 * Monitorea y diagnostica problemas de persistencia
 * Detecta cuando las funciones NO trabajan correctamente
 * Genera reportes detallados en archivos TXT
 */

import { 
  guardarDatosEmpresa, 
  cargarDatosEmpresa, 
  existenDatosEmpresa,
  limpiarDatosEmpresa 
} from './datosEmpresaPersistence';
import fileErrorLogger from './fileErrorLogger';

class EmpresaPersistenceMonitor {
  constructor() {
    this.testResults = [];
    this.functionsStatus = new Map();
    this.isMonitoring = false;
    this.lastTestTime = null;
    
    this.setupMonitoring();
  }

  /**
   * üöÄ INICIAR MONITOREO PERSISTENCIA
   */
  async startMonitoring() {
    if (this.isMonitoring) {
      //console.log('üîç Monitor persistencia ya est√° activo');
      return;
    }

    //console.log('üîç Iniciando monitor persistencia datos empresa...');
    
    try {
      // Test inicial completo
      await this.performFullPersistenceTest();
      
      // Configurar monitoreo autom√°tico
      this.setupAutomaticTesting();
      
      // Interceptar funciones para monitorear uso real
      this.interceptPersistenceFunctions();
      
      this.isMonitoring = true;
      //console.log('‚úÖ Monitor persistencia ACTIVO');
      
    } catch (error) {
      console.error('‚ùå Error iniciando monitor persistencia:', error);
      await fileErrorLogger.logCriticalError(
        'PERSISTENCE_MONITOR_INIT_FAILED',
        { error: error.message, timestamp: new Date().toISOString() },
        'PERSISTENCE_MONITOR'
      );
    }
  }

  /**
   * üß™ TEST COMPLETO DE PERSISTENCIA
   */
  async performFullPersistenceTest() {
    //console.log('üß™ Ejecutando test completo de persistencia...');
    
    const testData = {
      razon_social: `Test Empresa ${Date.now()}`,
      rut: '12345678-9',
      email: 'test@empresa.com',
      telefono: '+56912345678',
      direccion: 'Test Address 123',
      test_timestamp: Date.now()
    };

    const testResults = {
      timestamp: new Date().toISOString(),
      tests: []
    };

    // Test 1: Funci√≥n guardarDatosEmpresa
    try {
      //console.log('üìù Test 1: Guardando datos empresa...');
      const saveResult = guardarDatosEmpresa(testData);
      
      testResults.tests.push({
        function: 'guardarDatosEmpresa',
        status: saveResult.success ? 'PASS' : 'FAIL',
        details: saveResult,
        timestamp: new Date().toISOString()
      });
      
      this.functionsStatus.set('guardarDatosEmpresa', saveResult.success ? 'WORKING' : 'BROKEN');
      
    } catch (error) {
      testResults.tests.push({
        function: 'guardarDatosEmpresa',
        status: 'ERROR',
        error: error.message,
        timestamp: new Date().toISOString()
      });
      
      this.functionsStatus.set('guardarDatosEmpresa', 'BROKEN');
      
      await fileErrorLogger.logCriticalError(
        'PERSISTENCE_SAVE_FUNCTION_BROKEN',
        { function: 'guardarDatosEmpresa', error: error.message },
        'PERSISTENCE_MONITOR'
      );
    }

    // Test 2: Funci√≥n cargarDatosEmpresa
    try {
      //console.log('üìñ Test 2: Cargando datos empresa...');
      const loadResult = cargarDatosEmpresa();
      
      const dataMatches = loadResult.success && 
                         loadResult.datos?.razon_social === testData.razon_social;
      
      testResults.tests.push({
        function: 'cargarDatosEmpresa',
        status: dataMatches ? 'PASS' : 'FAIL',
        details: { loadResult, dataMatches },
        timestamp: new Date().toISOString()
      });
      
      this.functionsStatus.set('cargarDatosEmpresa', dataMatches ? 'WORKING' : 'BROKEN');
      
      if (!dataMatches) {
        await fileErrorLogger.logHighError(
          'PERSISTENCE_LOAD_DATA_MISMATCH',
          { 
            expected: testData.razon_social,
            received: loadResult.datos?.razon_social,
            fullResult: loadResult
          },
          'PERSISTENCE_MONITOR'
        );
      }
      
    } catch (error) {
      testResults.tests.push({
        function: 'cargarDatosEmpresa',
        status: 'ERROR',
        error: error.message,
        timestamp: new Date().toISOString()
      });
      
      this.functionsStatus.set('cargarDatosEmpresa', 'BROKEN');
    }

    // Test 3: Funci√≥n existenDatosEmpresa
    try {
      //console.log('üîç Test 3: Verificando existencia datos...');
      const existsResult = existenDatosEmpresa();
      
      testResults.tests.push({
        function: 'existenDatosEmpresa',
        status: existsResult ? 'PASS' : 'FAIL',
        details: { exists: existsResult },
        timestamp: new Date().toISOString()
      });
      
      this.functionsStatus.set('existenDatosEmpresa', existsResult ? 'WORKING' : 'BROKEN');
      
    } catch (error) {
      testResults.tests.push({
        function: 'existenDatosEmpresa',
        status: 'ERROR',
        error: error.message,
        timestamp: new Date().toISOString()
      });
      
      this.functionsStatus.set('existenDatosEmpresa', 'BROKEN');
    }

    // Test 4: Navegaci√≥n simulation
    try {
      //console.log('üåê Test 4: Simulando navegaci√≥n (recarga localStorage)...');
      
      // Simular recarga - limpiar sessionStorage pero mantener localStorage
      const originalSessionData = sessionStorage.getItem('lpdp_sesion_actual_empresa');
      sessionStorage.removeItem('lpdp_sesion_actual_empresa');
      
      // Intentar cargar despu√©s de "navegaci√≥n"
      const loadAfterNav = cargarDatosEmpresa();
      
      const persistedCorrectly = loadAfterNav.success && 
                                loadAfterNav.datos?.razon_social === testData.razon_social;
      
      testResults.tests.push({
        function: 'navigation_persistence',
        status: persistedCorrectly ? 'PASS' : 'FAIL',
        details: { 
          persistedAfterNavigation: persistedCorrectly,
          loadResult: loadAfterNav
        },
        timestamp: new Date().toISOString()
      });
      
      // Restaurar sessionStorage
      if (originalSessionData) {
        sessionStorage.setItem('lpdp_sesion_actual_empresa', originalSessionData);
      }
      
      if (!persistedCorrectly) {
        await fileErrorLogger.logCriticalError(
          'PERSISTENCE_NAVIGATION_FAILURE',
          { 
            description: 'Datos se pierden al navegar - localStorage no funciona',
            loadAfterNavigation: loadAfterNav
          },
          'PERSISTENCE_MONITOR'
        );
      }
      
    } catch (error) {
      testResults.tests.push({
        function: 'navigation_persistence',
        status: 'ERROR',
        error: error.message,
        timestamp: new Date().toISOString()
      });
    }

    // Test 5: Limpiar datos de prueba
    try {
      limpiarDatosEmpresa();
      //console.log('üßπ Datos de prueba limpiados');
    } catch (error) {
      //console.warn('‚ö†Ô∏è Error limpiando datos de prueba:', error);
    }

    // Guardar resultados
    this.testResults.push(testResults);
    this.lastTestTime = Date.now();

    // Generar reporte en archivo TXT
    await this.generatePersistenceReport(testResults);

    return testResults;
  }

  /**
   * üï∑Ô∏è INTERCEPTAR FUNCIONES PARA MONITOREO EN TIEMPO REAL
   */
  interceptPersistenceFunctions() {
    // Interceptar window.guardarDatosEmpresa si existe
    if (typeof window.guardarDatosEmpresa === 'function') {
      const originalGuardar = window.guardarDatosEmpresa;
      
      window.guardarDatosEmpresa = (...args) => {
        const timestamp = new Date().toISOString();
        //console.log('üîç MONITOR: Llamada a guardarDatosEmpresa detectada', timestamp);
        
        try {
          const result = originalGuardar(...args);
          
          if (!result.success) {
            fileErrorLogger.logHighError(
              'REAL_TIME_SAVE_FAILURE',
              { 
                args: args,
                result: result,
                timestamp: timestamp
              },
              'PERSISTENCE_MONITOR'
            );
          }
          
          return result;
        } catch (error) {
          fileErrorLogger.logCriticalError(
            'REAL_TIME_SAVE_ERROR',
            {
              error: error.message,
              args: args,
              timestamp: timestamp
            },
            'PERSISTENCE_MONITOR'
          );
          throw error;
        }
      };
    }

    // Interceptar window.cargarDatosEmpresa si existe
    if (typeof window.cargarDatosEmpresa === 'function') {
      const originalCargar = window.cargarDatosEmpresa;
      
      window.cargarDatosEmpresa = (...args) => {
        const timestamp = new Date().toISOString();
        //console.log('üîç MONITOR: Llamada a cargarDatosEmpresa detectada', timestamp);
        
        try {
          const result = originalCargar(...args);
          
          if (!result.success || !result.datos) {
            fileErrorLogger.logHighError(
              'REAL_TIME_LOAD_FAILURE',
              { 
                args: args,
                result: result,
                timestamp: timestamp,
                description: 'Carga fall√≥ o retorn√≥ datos vac√≠os'
              },
              'PERSISTENCE_MONITOR'
            );
          }
          
          return result;
        } catch (error) {
          fileErrorLogger.logCriticalError(
            'REAL_TIME_LOAD_ERROR',
            {
              error: error.message,
              args: args,
              timestamp: timestamp
            },
            'PERSISTENCE_MONITOR'
          );
          throw error;
        }
      };
    }
  }

  /**
   * ‚è∞ CONFIGURAR TESTING AUTOM√ÅTICO
   */
  setupAutomaticTesting() {
    // Test cada 30 minutos
    setInterval(async () => {
      try {
        await this.performFullPersistenceTest();
      } catch (error) {
        console.error('‚ùå Error en test autom√°tico persistencia:', error);
      }
    }, 30 * 60 * 1000);
  }

  /**
   * üîÑ CONFIGURAR MONITOREO B√ÅSICO
   */
  setupMonitoring() {
    // Monitor cambios en localStorage
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = (key, value) => {
      if (key.includes('empresa')) {
        //console.log('üîç localStorage.setItem detectado para empresa:', key);
      }
      return originalSetItem.call(localStorage, key, value);
    };

    // Monitor errores storage
    window.addEventListener('error', (event) => {
      if (event.message.includes('localStorage') || event.message.includes('sessionStorage')) {
        fileErrorLogger.logHighError(
          'STORAGE_ERROR_DETECTED',
          {
            message: event.message,
            filename: event.filename,
            timestamp: new Date().toISOString()
          },
          'PERSISTENCE_MONITOR'
        );
      }
    });
  }

  /**
   * üìä GENERAR REPORTE PERSISTENCIA
   */
  async generatePersistenceReport(testResults) {
    const failedTests = testResults.tests.filter(t => t.status === 'FAIL' || t.status === 'ERROR');
    const workingFunctions = Array.from(this.functionsStatus.entries())
      .filter(([func, status]) => status === 'WORKING')
      .map(([func]) => func);
    const brokenFunctions = Array.from(this.functionsStatus.entries())
      .filter(([func, status]) => status === 'BROKEN')
      .map(([func]) => func);

    const report = {
      timestamp: testResults.timestamp,
      overall_status: failedTests.length === 0 ? 'HEALTHY' : 'CRITICAL',
      summary: {
        total_functions_tested: testResults.tests.length,
        working_functions: workingFunctions.length,
        broken_functions: brokenFunctions.length,
        critical_issues: failedTests.length
      },
      function_status: {
        working: workingFunctions,
        broken: brokenFunctions
      },
      failed_tests: failedTests,
      recommendations: this.generateRecommendations(failedTests)
    };

    // Escribir reporte a archivo TXT
    if (failedTests.length > 0) {
      await fileErrorLogger.logCriticalError(
        'PERSISTENCE_FUNCTIONS_NOT_WORKING',
        report,
        'PERSISTENCE_MONITOR'
      );
    } else {
      await fileErrorLogger.logMediumError(
        'PERSISTENCE_HEALTH_REPORT',
        report,
        'PERSISTENCE_MONITOR'
      );
    }

    return report;
  }

  /**
   * üí° GENERAR RECOMENDACIONES
   */
  generateRecommendations(failedTests) {
    const recommendations = [];

    if (failedTests.some(t => t.function === 'guardarDatosEmpresa')) {
      recommendations.push('FIX CR√çTICO: Funci√≥n guardarDatosEmpresa no funciona - revisar localStorage access');
    }

    if (failedTests.some(t => t.function === 'cargarDatosEmpresa')) {
      recommendations.push('FIX CR√çTICO: Funci√≥n cargarDatosEmpresa no funciona - datos se pierden');
    }

    if (failedTests.some(t => t.function === 'navigation_persistence')) {
      recommendations.push('FIX CR√çTICO: Persistencia falla entre navegaci√≥n - usuario pierde datos');
    }

    if (recommendations.length === 0) {
      recommendations.push('‚úÖ Todas las funciones de persistencia est√°n funcionando correctamente');
    }

    return recommendations;
  }

  /**
   * üìä OBTENER ESTADO ACTUAL
   */
  getCurrentStatus() {
    return {
      monitoring_active: this.isMonitoring,
      last_test: this.lastTestTime ? new Date(this.lastTestTime).toISOString() : null,
      functions_status: Object.fromEntries(this.functionsStatus),
      total_tests_performed: this.testResults.length
    };
  }

  /**
   * üñ®Ô∏è IMPRIMIR REPORTE EN CONSOLA
   */
  printStatusReport() {
    const status = this.getCurrentStatus();
    
    console.group('üîç REPORTE MONITOR PERSISTENCIA');
    //console.log('Estado monitoreo:', status.monitoring_active ? '‚úÖ ACTIVO' : '‚ùå INACTIVO');
    //console.log('√öltimo test:', status.last_test || 'Nunca ejecutado');
    //console.log('Tests realizados:', status.total_tests_performed);
    
    console.group('üìã Estado Funciones');
    Object.entries(status.functions_status).forEach(([func, status]) => {
      const icon = status === 'WORKING' ? '‚úÖ' : '‚ùå';
      //console.log(`${icon} ${func}: ${status}`);
    });
    console.groupEnd();
    
    console.groupEnd();
    
    return status;
  }
}

// Instancia global
const empresaPersistenceMonitor = new EmpresaPersistenceMonitor();

// Hacer disponible globalmente
window.empresaPersistenceMonitor = empresaPersistenceMonitor;
window.testPersistencia = () => empresaPersistenceMonitor.performFullPersistenceTest();
window.statusPersistencia = () => empresaPersistenceMonitor.printStatusReport();

// Auto-iniciar si estamos en el navegador
if (typeof window !== 'undefined') {
  empresaPersistenceMonitor.startMonitoring();
}

export default empresaPersistenceMonitor;